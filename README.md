# Анализатор кода

Инструмент для автоматического анализа кода и генерации документации с использованием языковых моделей.

## Возможности

- Анализ отдельных файлов или целых директорий с кодом
- Рекурсивный обход директорий
- Поддержка языков программирования: Kotlin, Java
- Генерация документации в формате KDoc
- Учет контекстных файлов при анализе кода
- Детальное логирование процесса анализа
- Сохранение результатов в указанную директорию с поддержкой структуры папок
- Кэширование результатов для ускорения работы
- Автоматическое определение режима работы
- Валидация документации для устранения лишнего кода
- Сохранение структуры исходных файлов (пакеты, импорты)

## Требования

- Python 3.8+
- Ollama сервер с запущенной LLM-моделью
- Рекомендуется: модель с контекстом не менее 8K токенов

## Установка

1. Клонируйте репозиторий:
   ```
   git clone <url-репозитория>
   cd codeanalysistool
   ```

2. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```

3. Убедитесь, что сервер Ollama запущен и имеет загруженную модель.

## Использование

### Режимы работы

Инструмент поддерживает два режима работы:

1. **Стандартный режим** - анализ проекта и генерация документации в markdown формате
2. **Режим обработки файлов** - обработка отдельных файлов и генерация документации в формате исходного кода

Режим определяется автоматически на основе типа переданного пути:
- Если указан файл - используется режим обработки файлов
- Если указана директория - используется стандартный режим анализа проекта

### Запуск из командной строки

```bash
analyze_code.bat [путь] [опции]
```

Также можно явно указать режим:
```bash
analyze_code.bat --legacy [путь] [опции]  # Принудительный режим обработки файлов
```

### Запуск через Python

```bash
python src/analyzer_cli.py [путь] [опции]
```

### Параметры командной строки (стандартный режим)

- `input_dir` - Директория с исходным кодом (необязательно при запуске тестов)
- `--output` - Путь к файлу с результатами (по умолчанию: "docs/analysis.md")
- `--cache-dir` - Директория для кэширования (по умолчанию: ".cache")
- `--verbose` - Подробный вывод
- `--clear-logs` - Очистить лог-файлы перед запуском
- `--test` - Запустить тесты вместо анализа
- `--clean-cache` - Очистить кэш перед запуском

### Параметры командной строки (режим обработки файлов)

- `path` - Путь к файлу или директории для анализа (обязательный)
- `-o, --output` - Директория для сохранения результатов (по умолчанию: "output")
- `-r, --recursive` - Рекурсивно обрабатывать вложенные директории (по умолчанию: True)
- `-c, --context` - Пути к файлам контекста через запятую (по умолчанию: пусто)
- `--log-level` - Уровень логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL (по умолчанию: INFO)

### Примеры

#### Анализ проекта (автоопределение режима)

```
analyze_code.bat path/to/project
```

С указанием выходного файла:
```
analyze_code.bat path/to/project --output docs/myproject.md
```

#### Анализ отдельного файла (автоопределение режима)

```
analyze_code.bat path/to/MyClass.kt
```

С указанием выходной директории:
```
analyze_code.bat path/to/MyClass.kt -o documentation
```

С контекстными файлами:
```
analyze_code.bat path/to/MyClass.kt -c path/to/BaseClass.kt,path/to/Interface.kt
```

#### Запуск тестов

```
analyze_code.bat --test
```

## Структура проекта

```
codeanalysistool/
├── src/
│   ├── code_analyzer/       # Модуль анализатора кода
│   │   ├── __init__.py
│   │   ├── code_analyzer.py # Основной класс анализатора
│   │   └── file_processor.py # Обработка файлов и папок
│   ├── llm/                 # Взаимодействие с LLM-моделями
│   │   ├── __init__.py
│   │   └── llm_client.py    # Клиент для Ollama
│   ├── test/                # Тесты
│   │   └── test_code_analyzer.py
│   ├── main.py              # Основной модуль для анализа проектов
│   └── analyzer_cli.py      # CLI-интерфейс
├── logs/                    # Директория для логов
├── output/                  # Директория для результатов
├── docs/                    # Директория для документации
├── .cache/                  # Директория для кэша
├── analyze_code.bat         # Скрипт для запуска в Windows
└── README.md                # Документация проекта
```

## Логирование

Логи сохраняются в директории `logs/` с именем файла, содержащим дату и время запуска:
```
logs/code_analyzer_YYYYMMDD_HHMMSS.log
```

В стандартном режиме логи также сохраняются в файле `code_analysis.log`.

## Структура выходных файлов

### Стандартный режим
В стандартном режиме генерируется один markdown-файл со всей документацией проекта. Файл содержит:
- Список всех проанализированных файлов, сгруппированных по директориям
- Документацию для каждого класса, также сгруппированную по директориям

### Режим обработки файлов
В режиме обработки файлов сохраняется оригинальная структура директорий и файлов:
- Создаются те же директории, что и в исходном проекте
- Документация добавляется к оригинальному коду в правильном месте
- Сохраняются только файлы с поддерживаемыми расширениями

Структура каждого выходного файла:
1. Объявление пакета (если есть в оригинальном файле)
2. Импорты (если есть в оригинальном файле)
3. Новая документация в формате KDoc
4. Оригинальный код класса (без старой документации)

Пример исходного файла:
```kotlin
package com.example

import android.os.Bundle
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
    }
}
```

Пример выходного файла с документацией:
```kotlin
package com.example

import android.os.Bundle
import androidx.appcompat.app.AppCompatActivity

/**
 * Основной экран приложения.
 *
 * Отвечает за инициализацию пользовательского интерфейса
 * и обработку взаимодействия с пользователем.
 *
 * @property savedInstanceState Состояние активности при восстановлении
 * 
 * @see AppCompatActivity
 * 
 * **Внешние зависимости:**
 * - androidx.appcompat.app.AppCompatActivity
 *
 * **Взаимодействие:**
 * - Использует Layout из R.layout.activity_main
 */
class MainActivity : AppCompatActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)
    }
}
```

## Валидация документации

Инструмент выполняет автоматическую валидацию документации для исключения случаев, когда модель возвращает лишний код:

1. Проверяет, что документация начинается с `/**` и заканчивается на `*/`
2. Удаляет любой текст до начала KDoc комментария
3. Удаляет любой текст после закрывающего тега комментария
4. Удаляет строки, содержащие `[Краткое описание]` (часто добавляемые моделью как заглушки)
5. Удаляет тройные обратные кавычки (```) в начале и конце документации
6. Обнаруживает и удаляет любой код, добавленный после закрывающего тега `*/`

## Примечания

- Генерация документации выполняется только для поддерживаемых типов файлов (в настоящее время: Kotlin, Java)
- Убедитесь, что анализируемые файлы имеют корректную кодировку UTF-8
- Для лучших результатов рекомендуется использовать большие языковые модели (7B+)
- Кэширование результатов позволяет значительно ускорить повторный анализ
- При изменении файла его кэш автоматически обновляется
- Если в исходном файле уже есть KDoc документация, она будет заменена на новую